# 第三章 第 1 节 缺失值处理精讲

> 原文：[`www.nowcoder.com/tutorial/10067/f7db66c4bb77457895365b603d333ad3`](https://www.nowcoder.com/tutorial/10067/f7db66c4bb77457895365b603d333ad3)

# 一、写在前面

假设你是一家咖啡店的老板，有一天收到了这样的一个订单“数量：2 杯，大小：中杯，冷热：热，口味： ”，很明显，“口味”的信息是缺失的，那么你会怎样来制作两杯咖啡呢？你可能有以下几种选择：

1.  这条订单信息不完整，不制作任何咖啡
2.  口味缺失时，默认口味为原味，制作原味咖啡
3.  查看以下销量最好的咖啡是什么口味的，按照这个口味来制作咖啡
4.  打电话给下单顾客，明确他们想要的口味，然后再制作

当咖啡“口味”缺少时，我们可以有多种选择，更重要的是，不同的选择会导致不同的结果。比如，你选择以默认口味来制作咖啡，万一这个口味很符合顾客的喜好，那么 TA 可能会继续下单；但如果顾客不喜欢你决定的口味，TA 可能会抱怨你的擅自作主，甚至给你差评。

与咖啡“口味”缺失时处理类似，在机器学习实践中同样会遇到缺失值，面对缺失值，我们同样有多种处理方式(如直接删除或填充)，不同的处理方式会有不同的效果，这里的效果是指会对算法模型的表现产生影响。

**这篇文章会涵盖以下内容：介绍缺失值出现的原因、缺失值的几种形式、如何使用 pandas 检测缺失值，介绍如何处理缺失值及使用 pandas 进行实战，最后介绍经典机器学习模型对缺失值的敏感度和相关面试题。**

* * *

# 二、缺失值出现的原因

导致缺失值出现的原因大概有四个，可以归结为两类或两个阶段，即信息收集阶段和信息处理阶段。具体如下：

​ **信息收集阶段**：

*   用户没有提供任何信息，比如你设计了一个中文调查问卷，却遇到了一个不懂中文的外国朋友，这时候 TA 很有可能没有提供任何的信息。

*   用户提供了部分信息：用户忘记填写某个信息或者用户认为该信息属于敏感或安全信息，刻意不填写；或者回答的问题是无效的。

*   数据录入人员失误漏录了数据。

    **信息处理阶段**：

*   程序员在存储用户信息时，忘记保存某个字段。

*   数据在从数据库转移时，出现的丢失及类型转换的不兼容问题。

*   硬件问题，比如存储器损坏，机械故障导致某段时间数据未能收集。

尽管这几个原因与机器学习工程师没有太大关系，但仍有必要了解缺失值的来龙去脉，并将相关信息反馈给上游部门，毕竟缺失值会给我们的工作带来许多问题。

首先，缺失值的处理会占用大量的时间。关于数据科学家，广泛流传着这样的一个说法：“数据科学家 80%的时间花在获取、清洗、管理数据上，只有 20%的时间用于分析数据和机器学习“。

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957770/0081Kckwly1gkk4z4myizj30x809jwgl.jpg`](img/0e2bb7fc8d54589a4821634b84f0c58d.png)

其次，缺失值会增加模型的不确定性，并对模型的表现产生影响，如导致错误的预测或高偏差。比如，涉及到距离度量(distance measurement)时，如计算两个点之间的距离，缺失数据就变得比较重要。因为涉及到“距离”这个概念，那么缺失值处理不当就会导致效果很差，如 K 近邻算法(KNN)和支持向量机(SVM)。 线性模型的代价函数(loss function)往往涉及到距离(distance)的计算，计算预测值和真实值之间的差别，这容易导致对缺失值敏感。几种经典的机器学习算法模型对于缺失值的敏感度会在后面的部分专门提到。

除此之外，缺失值还会对最终结论的得出产生影响。

| Name | Weight | Gender | Play cricket/Not |
| :-: | :-: | :-: | :-: |
| Mr. Amit | 55 | M | Y |
| Mr. Anil | 58 | M | N |
| Miss Swati | 50 | F | Y |
| Miss Richa | 51 |  | Y |
| Mr. Steve | 53 | M | Y |
| Miss Reena | 52 |  | Y |
| Miss Rashimi | 50 |  | Y |
| Mr. Kunal | 60 | M | Y |

很明显，Gender 列有几个缺失值，假设我们不对缺失值做处理的话，从上图得出的结论就是男生比女生更喜欢打板球。但是，在我们根据 Mr、Miss 将 Gender 列填充完毕后(下面的表格)，就会得出与之相反的结论——女生比男生更喜欢打板球，通过这个例子，就可以体会到缺失值对最终的结论有很大的影响，即数据的缺失或缺失程度直接影响到数据的质量，而数据的质量最终影响到我们的研究成果。如果对缺失数据的处理不当，很可能导致整个统计分析失败。

| Name | Weight | Gender | Play cricket/Not |
| :-: | :-: | :-: | :-: |
| Mr. Amit | 55 | M | Y |
| Mr. Anil | 58 | M | N |
| Miss Swati | 50 | F | Y |
| Miss Richa | 51 | F | Y |
| Mr. Steve | 53 | M | Y |
| Miss Reena | 52 | F | Y |
| Miss Rashimi | 50 | F | Y |
| Mr. Kunal | 60 | M | Y |

最后，缺失值可能会与一些机器学习的一些工具包，比如 scikit-learn，发生一些不兼容的问题。这是因为 scikit-learn 内部的一些类会假定所有的值都是数字类型的且都有其意义。

* * *

# 三、缺失值的几种形式

1.  pandas 会将缺失值表示为***NA***，它表示不可用 not available。NA 数据有两层含义，可能是不存在的数据或者虽然存在，但是没有观察到，例如，数据采集中发生了问题。
2.  标准缺失值：NaN 和 None。对于数值数据，pandas 使用浮点值***NaN***（Not a Number）表示缺失数据；Python 内置的***None***值在对象数组中也可以作为 NA。
3.  非标准缺失值：如"na", "n/a", "--", "Null”, “missing”, “not available”, “NA”,"?"...这些“标记”是人们自定义的，但 pandas 并不会将这些值识别为 NA，所以需要额外处理。处理方法就是将它们保存到一个 list 中，然后作为参数传递给 read_csv()方法，这样 pandas 在读取数据时，就会将这些值识别为 NA。代码如下：

```cpp
missing_values = ["na", "n/a", "--", "Null", "missing", "not available", "NA"]
df = pd.read_csv("xxx.csv", na_values = missing_values)
```

1.  前面几种形式的缺失值比较好辨认，一眼就可以识别出，但有种形式的缺失值比价抽象，不太容易辨认，需要写一些代码来处理。比如，在离散值的列里(比如只有'Y'和‘N’这两个字符串)出现了数字，这个时候就需要将这数字标记为缺失值；或者在表示工作年限的列里出现了-1，这个时候-1 就需要被标记为缺失值。

* * *

# 四、缺失值的识别与统计分析

我会使用 kaggle [泰坦尼克](https://www.kaggle.com/c/titanic)的数据集来说明如何使用 pandas 识别缺失值

读取数据集

```cpp
import pandas as pd

train_data = pd.read_csv('/kaggle/input/titanic/train.csv')
```

**data_name.info() :** 汇总数据总数量以及非 NA 的数量，通过对比这两个指标，就可以知道数据缺失的程度。

```cpp
train_data.info()
  结果如下：      
```

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957826/0081Kckwly1gkka021n6dj30ku0k0wi3.jpg`](img/3e78afb062ac5d2e4ca073d564aa86c3.png)

从上图中可以看出，一共有 891 行数据，Age 列非 NaN 共有 714 个数据，Cabin 列缺失严重，只有 204 个。

我们可以对缺失值进行可视化，这样哪个特征的缺失值就会一目了然。代码如下：

```cpp
import missingno as msno

msno.matrix(train_data)
```

结果如下图所示：白色区域表示缺失值

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957888/0081Kckwly1gkmjux8izzj31jq0q6gq8.jpg`](img/ba074a0d6eb5b422201b48c572b8dc07.png)

***data_name.describe()***会给出特征统计值的汇总情况。其中最重要的一行是 min 值。如果我们发现在年龄、性别或体重列中出现了-1 或其他异常值，可以将其视为缺失值

```cpp
train_data.describe() # 默认展示数值类型的列的统计信息
```

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957826/0081Kckwly1gkka7xnm73j30x60e4gnk.jpg`](img/6c8b039a5328f2c5346f5174a1877b05.png)

```cpp
train_data.describe(include='all') # 展示所有列的统计信息
```

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957827/0081Kckwly1gks18gnku3j31hg0j0ade.jpg`](img/0136cf9c9343a3c6f26695428ff08524.png)

***data_name.head()***: 会展示前几行的数据，可以通过这种方式快速浏览一下，看看是否有缺失值的存在

```cpp
train_data.describe()
```

结果如下：

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957803/0081Kckwly1gkkadhj6ddj319m0a8jte.jpg`](img/b0bf808318d6dab4fc314801430ef2cc.png)

从上图可以很明显地看出，Cabin 列前五行的数据都是缺失值。

***data_name.isnull()***会直接输出该行数据是否缺失；若为缺失值，则显示 True，反之，则为 False

```cpp
train_data.isnull()
```

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957628/0081Kckwly1gkkajywzm5j310s0j8wg7.jpg`](img/8261574bf3a69c23bb24018a69f2fcd2.png)

data_name.isnull().sum()会统计每个特征的缺失值个数

```cpp
train_data.isnull().sum()
```

![`uploadfiles.nowcoder.com/files/20210201/897353_1612166957787/0081Kckwly1gkkaoak87vj30i40e4wfj.jpg`](img/ed8d5ff25d899386a0ee4b5b5689ef17.png)

从上图中可以看出，Cabin 列缺失值数量最多，为 687 个。

```cpp
# 统计数据集缺失值总个数
train_data.isnull().sum().sum() # 866
```

***data_name.isnull().values.any(***): 判断数据集中是否存在缺失值，若存在，返回 True，否则 False

```cpp
train_data.isnull().values.any() # True
```

* * *

### 五、缺失值的处理方式

```cpp
     缺失值的处理方式大概可以分为两种，第一种是直接丢掉含有缺失值的行；第二种方式是对缺失值进行填充。下面会对这两种方式进行介绍。
```

**1\. 直接删除含有缺失值的行。**
适用场景：缺失数据没有意义或重要性低，或者缺失数据的比例超过 80%。这种方式简单粗暴，是最快速同时也是最容易的。但是，通常不建议采用这种方法。原因是这种方式有很大的局限性。它是以减少历史数据来换取信息的完备，会造成资源的大量浪费，丢弃了大量隐藏在这些对象中的信息，会降低我们模型的质量；它删除了很多数据，从而使得训练集的样本数变少。尤其是当训练集比较小的时候，这种方式更不可取，而应该采用填充的方法。

**2\. 填充。填充主要可以分为以下几种方式**

1.  使用统计值进行填充，如均值、中位数、众数。根据缺失值类型是连续型还是离散型，填充方式又不一样，具体如下：
    1.  若缺失值为连续型，考虑使用均值或中位数来填充。若数据存在离群值，则不适合使用均值，考虑使用中位数来代替。
    2.  若缺失值为离散型，考虑使用众数来填充。这种方式又可以细分为两种，第一种是广义填充，在这种情况下，计算所有非缺失值的均值或中位数，然后用均值或中位数进行填充；第二种是相似填充，比如填充年龄的时候，我们可以按性别计算出男生和女生年龄的平均值或中位数，然后根据性别再来填充；如果缺失值占总体的比例非常小，那么直接填入平均值、中位数或众数；此外，若变量的不同值较少，可转换成哑变量，例如性别 SEX 变量，存在 male,fameal,NA 三个不同的值，可将该列转换成 IS_SEX_MALE, IS_SEX_FEMALE, IS_SEX_NA。若某个变量存在十几个不同的值，可根据每个值的频数，将频数较小的值归为一类'other'，降低维度。此做法可最大化保留变量的信息。这样做的好处是完整保留了原始数据的全部信息、不用考虑缺失值、不用考虑线性不可分之类的问题。缺点是计算量大大提升，而且只有在样本量非常大的时候效果才好，否则会因为过于稀疏，效果很差。
2.  使用随机值进行填充。
3.  使用上下数据进行填充：使用缺失值的上一个或下一个的非缺失值进行填充。
4.  使用模型预测缺失值进行填充。这种方法可能是截止到目前所介绍的几种方法中最好最高效的方法。根据缺失值的类型，我们可以用回归模型或分类来预测缺失值。这种方法把某一特征的缺失值标记为目标值(y 变量)，然后用其他特征建立模型来预测缺失值。过程大致如下：假设 A 列存在缺失值，我们想对 A 列的缺失值进行预测。将数据集划分为 X_train 和 X_test,划分标准是对应的 A 列是否含有缺失值，其中 X_train 里的 A 列不包含缺失值，而 X_test 里的 A 列只包含缺失值(也就是我们要预测的)；将 X_train 里的 A 列独立出来并标记为 y_train；然后用除去 A 列的其他特征(即 X_train)及 A 列非缺失值(y_train)对模型进行训练；最后用模型对 X_test 进行预测，得到 y_test; 最后将这些数据集进行合并。这种方法的唯一缺点就是，含有缺失值的特征与其他特征不相关的话，会在预测缺失值的时候引起偏差。
5.  有时候还有可能遇到这样一种情况，那就是训练集 train 中有缺失值，而 test 中无缺失值。这时候最适合的处理方式应该是对缺失值取该特征下所有非缺失值条件均值或条件中值，即根据该用户的 label 值类别，取所有该 label 下用户该属性的平均值或中位数